<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">(function() {
    &#39;use strict&#39;;

<span id='Global-app-History'>    /**
</span>     * @class Global.app.History
     * HTML5 History API utility.
     * if the API dose not supported this class use hash flagment.
     * @extend Global.core.ObservableClass
     */
    Global.define(&#39;Global.app.History&#39;,{

        extend: Global.core.ObservableClass,

        defaultPathName: &#39;&#39;,

        changeHash: false,

        eventName: {
            change: &#39;change&#39;
        },

<span id='Global-app-History-cfg-isSupported'>        /**
</span>         * @cfg {Boolean} isSupported whether browser spport History API or not
         */
        isSupported: history &amp;&amp; !!history.pushState,

<span id='Global-app-History-cfg-data'>        /**
</span>         * @cfg {Object} data
         */
        data: null,

<span id='Global-app-History-cfg-hashextention'>        /**
</span>         * @cfg {String} hashextention /# + ${hashextention}
         */
        hashExtention: &#39;!/&#39;,

<span id='Global-app-History-method-state'>        /**
</span>         * @method state
         * get state data
         */
        state: function() {
            return this.getData();
        },

<span id='Global-app-History-method-length'>        /**
</span>         * @method length
         * get state length
         */
        length: function() {
            return this.isSupported ? history.length : null;
        },

<span id='Global-app-History-method-constructor'>        /**
</span>         * @constructor
         */
        init: function(config) {
            this._super(config);
            this._setUseHash(this.useHash);
            this._bind();
        },

        _setUseHash: function(useHash) {
            if(useHash){
                this.isSupported = false;
            }
        },

<span id='Global-app-History-method-pushState'>        /**
</span>         * @method pushState
         * change url
         * if History API dose not supported use change hash flagment
         */
        pushState: function(path, state, title) {
            var _path,
                dpn = this.getDefaultPathName();
            this.setData(state);
            if(this.isSupported){
                _path = dpn + path;
                history.pushState(state, title, _path);
            }else{
                this.setChangeHash(true);
                location.hash = this._getHashByPathName(path);
            }
        },

<span id='Global-app-History-method-forward'>        /**
</span>         * @method forward
         * same as history.forward()
         */
        forward: function() {
            history.forward();
        },

<span id='Global-app-History-method-back'>        /**
</span>         * @method back
         * same as history.back()
         */
        back: function() {
            history.back();
        },

<span id='Global-app-History-method-go'>        /**
</span>         * @method go
         * same as history.go()
         */
        go: function() {
            history.go();
        },

<span id='Global-app-History-method-getNormalizePath'>        /**
</span>         * @method getNormalizePath
         * if your browser support history api return pathname from location.pathname
         * if your browser dose not supported history api return pathname from location.hash
         * the return path have slash at first child and dose not have slash at last child.
         */
        getNormalizePath: function() {
            var res;
            if(this.isSupported){
                res = this.getPathName();
            }else{
                res = this.getHash();
            }
            return res;
        },

<span id='Global-app-History-method-getPathName'>        /**
</span>         * @method getPathName
         * @return pathname which has slash at first child and excluding default pathname
         */
        getPathName: function() {
            var pathName = location.pathname;
            pathName = pathName.split(this.getDefaultPathName())[1];
            pathName = this._addSlashAtFirst(pathName);
            return this._getNoLastSlashPath(pathName);
        },

<span id='Global-app-History-method-getHash'>        /**
</span>         * @method getHash
         * @return pathname which has slash at first child and excluding hash extention (e.g. !#/)
         */
        getHash: function() {
            var hash = location.hash,
                path = this._changeHashToPathName(hash);
            return this._getNoLastSlashPath(path);
        },

        _changeHashToPathName: function(hash) {
            var prefix = &#39;#&#39; + this.getHashExtention(),
                pathName;
            if(!hash){
                pathName = &#39;/&#39;;
            }else{
                pathName = hash.split(prefix)[1];
                pathName = this._addSlashAtFirst(pathName);
            }
            return pathName;
        },

        _getHashByPathName: function(path) {
            var he = this.getHashExtention(),
                res;
            if(path === &#39;/&#39;){
                res = he;
            }else{
                res = he + (this._isFirstSlash(path) ? path.substring(1) : path);
            }
            return res;
        },

<span id='Global-app-History-method-_bind'>        /**
</span>         * @private
         */
        _bind: function() {
            if(this.isSupported){
                window.addEventListener(&#39;popstate&#39;, Global.Functions.bind(this._onPopState, this));
            }else{
                this._bindHashChange();
            }
        },

<span id='Global-app-History-method-_bindHashChange'>        /**
</span>         * @private
         */
        _bindHashChange: function() {
            var me = this,
                key = window.addEventListener ? &#39;addEventListener&#39; : &#39;attachEvent&#39;;
            window[key](&#39;hashchange&#39;, function(e) {
                if(!me.getChangeHash()){
                    me._onPopState(e);
                }
                me.setChangeHash(false);
            });
        },

<span id='Global-app-History-method-_onPopState'>        /**
</span>         * @private
         */
        _onPopState: function(e) {
            var data = {
                state: this.state(),
                raw : e
            };
            this.dispatchEvent(this.getEventName().change, data);
        },
        _isFirstSlash: function(str) {
            var reg = /^\//;
            return reg.test(str);
        },

        _addSlashAtFirst: function(str) {
            var res;
            if(Global.isUndefined(str)){
                res = undefined;
            }else{
                if(!this._isFirstSlash(str)){
                    str  = &#39;/&#39; + str;
                }
                res = str;
            }
            return str;
        },

        _getNoLastSlashPath: function(path){
            var reg = /\/$/;
            if(path === &#39;/&#39;){
                return path;
            }else{
                return reg.test(path) ? path.slice(0, -1) : path;
            }
        }

    });

})();
</pre>
</body>
</html>
